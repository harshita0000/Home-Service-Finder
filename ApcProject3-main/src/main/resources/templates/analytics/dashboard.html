<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Database Analytics - Urban Services</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .analytics-header {
            background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
            color: white;
            padding: 2rem 0;
        }
        .db-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .db-card:hover {
            transform: translateY(-3px);
        }
        .mongo-card { border-left: 5px solid #47A248; }
        .jdbc-card { border-left: 5px solid #00758F; }
        .jpa-card { border-left: 5px solid #6DB33F; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-purple">
        <div class="container">
            <a class="navbar-brand" href="/admin/dashboard">
                <i class="fas fa-chart-line me-2"></i>Analytics Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/admin/dashboard">Admin</a>
                <a class="nav-link" href="/logout">Logout</a>
            </div>
        </div>
    </nav>

    <!-- Analytics Header -->
    <div class="analytics-header">
        <div class="container">
            <h1><i class="fas fa-database me-3"></i>Multi-Database Analytics</h1>
            <p class="mb-0">JPA (H2) + MongoDB + JDBC (MySQL) Integration</p>
        </div>
    </div>

    <div class="container mt-4">
        <!-- Database Status Cards -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card db-card jpa-card">
                    <div class="card-body text-center">
                        <i class="fas fa-database fa-3x text-success mb-3"></i>
                        <h5>JPA (H2)</h5>
                        <p class="text-muted">Main application data</p>
                        <span class="badge bg-success">Connected</span>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card db-card mongo-card">
                    <div class="card-body text-center">
                        <i class="fas fa-leaf fa-3x text-success mb-3"></i>
                        <h5>MongoDB</h5>
                        <p class="text-muted">Analytics & Logs</p>
                        <span class="badge bg-success" id="mongoStatus">Connected</span>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card db-card jdbc-card">
                    <div class="card-body text-center">
                        <i class="fas fa-table fa-3x text-info mb-3"></i>
                        <h5>JDBC (MySQL)</h5>
                        <p class="text-muted">Performance Metrics</p>
                        <span class="badge bg-info" id="jdbcStatus">Connected</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Initialize Data Button -->
        <div class="row mb-4">
            <div class="col-12 text-center">
                <button class="btn btn-primary btn-lg" onclick="initializeAnalyticsData()">
                    <i class="fas fa-rocket me-2"></i>Initialize Sample Analytics Data
                </button>
            </div>
        </div>

        <!-- MongoDB Analytics Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card mongo-card">
                    <div class="card-header bg-success text-white">
                        <h5><i class="fab fa-envira me-2"></i>MongoDB Analytics Data</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Top Providers by Revenue</h6>
                                <div id="mongoRevenueData" class="table-responsive">
                                    <div class="text-center py-3">
                                        <div class="spinner-border text-success" role="status"></div>
                                        <p>Loading MongoDB data...</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Top Providers by Rating</h6>
                                <div id="mongoRatingData" class="table-responsive">
                                    <div class="text-center py-3">
                                        <div class="spinner-border text-success" role="status"></div>
                                        <p>Loading MongoDB data...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-4">
                            <div class="col-12">
                                <h6>Recent Service Logs</h6>
                                <div id="mongoLogsData">
                                    <div class="text-center py-3">
                                        <div class="spinner-border text-success" role="status"></div>
                                        <p>Loading service logs...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- JDBC Analytics Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card jdbc-card">
                    <div class="card-header bg-info text-white">
                        <h5><i class="fas fa-chart-bar me-2"></i>JDBC Performance Metrics</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Top Performing Providers</h6>
                                <div id="jdbcPerformanceData">
                                    <div class="text-center py-3">
                                        <div class="spinner-border text-info" role="status"></div>
                                        <p>Loading JDBC data...</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Category Revenue Summary</h6>
                                <div id="jdbcRevenueData">
                                    <div class="text-center py-3">
                                        <div class="spinner-border text-info" role="status"></div>
                                        <p>Loading revenue data...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Combined Analytics Chart -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line me-2"></i>Combined Database Analytics</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="combinedChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadAnalyticsData();
        });

        function initializeAnalyticsData() {
            fetch('/api/analytics/initialize', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert('Analytics data initialized successfully!');
                    loadAnalyticsData();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to initialize data. Please check database connections.');
            });
        }

        function loadAnalyticsData() {
            loadMongoData();
            loadJdbcData();
            loadCombinedChart();
        }

        function loadMongoData() {
            // Load MongoDB top providers by revenue
            fetch('/api/analytics/mongo/top-providers/revenue')
                .then(response => response.json())
                .then(data => {
                    if (Array.isArray(data)) {
                        const html = createProviderTable(data, 'revenue');
                        document.getElementById('mongoRevenueData').innerHTML = html;
                    }
                })
                .catch(error => {
                    document.getElementById('mongoRevenueData').innerHTML =
                        '<div class="alert alert-warning">MongoDB data not available</div>';
                });

            // Load MongoDB top providers by rating
            fetch('/api/analytics/mongo/top-providers/rating')
                .then(response => response.json())
                .then(data => {
                    if (Array.isArray(data)) {
                        const html = createProviderTable(data, 'rating');
                        document.getElementById('mongoRatingData').innerHTML = html;
                    }
                })
                .catch(error => {
                    document.getElementById('mongoRatingData').innerHTML =
                        '<div class="alert alert-warning">MongoDB data not available</div>';
                });

            // Load MongoDB recent logs
            fetch('/api/analytics/mongo/logs/recent')
                .then(response => response.json())
                .then(data => {
                    if (Array.isArray(data)) {
                        const html = createLogsTable(data);
                        document.getElementById('mongoLogsData').innerHTML = html;
                    }
                })
                .catch(error => {
                    document.getElementById('mongoLogsData').innerHTML =
                        '<div class="alert alert-warning">MongoDB logs not available</div>';
                });
        }

        function loadJdbcData() {
            // Load JDBC top performers
            fetch('/api/analytics/jdbc/providers/top-performers?limit=5')
                .then(response => response.json())
                .then(data => {
                    if (Array.isArray(data)) {
                        const html = createPerformanceTable(data);
                        document.getElementById('jdbcPerformanceData').innerHTML = html;
                    }
                })
                .catch(error => {
                    document.getElementById('jdbcPerformanceData').innerHTML =
                        '<div class="alert alert-warning">JDBC data not available</div>';
                });

            // Load JDBC revenue summary
            fetch('/api/analytics/jdbc/revenue/summary')
                .then(response => response.json())
                .then(data => {
                    if (Array.isArray(data)) {
                        const html = createRevenueSummaryTable(data);
                        document.getElementById('jdbcRevenueData').innerHTML = html;
                    }
                })
                .catch(error => {
                    document.getElementById('jdbcRevenueData').innerHTML =
                        '<div class="alert alert-warning">JDBC revenue data not available</div>';
                });
        }

        function createProviderTable(data, type) {
            const headers = type === 'revenue' ?
                '<th>Provider</th><th>Revenue</th><th>Bookings</th>' :
                '<th>Provider</th><th>Rating</th><th>Bookings</th>';

            const rows = data.map(provider => {
                const value = type === 'revenue' ?
                    `$${provider.totalRevenue?.toFixed(2) || '0.00'}` :
                    `${provider.averageRating?.toFixed(1) || '0.0'} ⭐`;

                return `
                    <tr>
                        <td>${provider.providerName || 'N/A'}</td>
                        <td>${value}</td>
                        <td>${provider.totalBookings || 0}</td>
                    </tr>
                `;
            }).join('');

            return `
                <table class="table table-sm">
                    <thead><tr>${headers}</tr></thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        }

        function createLogsTable(logs) {
            const rows = logs.slice(0, 5).map(log => `
                <tr>
                    <td><small>${new Date(log.timestamp).toLocaleString()}</small></td>
                    <td><span class="badge bg-primary">${log.action}</span></td>
                    <td>${log.description}</td>
                </tr>
            `).join('');

            return `
                <table class="table table-sm">
                    <thead>
                        <tr><th>Time</th><th>Action</th><th>Description</th></tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        }

        function createPerformanceTable(data) {
            const rows = data.map(provider => `
                <tr>
                    <td>${provider.providerName}</td>
                    <td>$${provider.totalEarnings?.toFixed(2) || '0.00'}</td>
                    <td>${provider.completedJobs || 0}</td>
                    <td>${provider.customerSatisfactionScore?.toFixed(1) || '0.0'}</td>
                </tr>
            `).join('');

            return `
                <table class="table table-sm">
                    <thead>
                        <tr><th>Provider</th><th>Earnings</th><th>Jobs</th><th>Satisfaction</th></tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        }

        function createRevenueSummaryTable(data) {
            const rows = data.map(category => `
                <tr>
                    <td>${category.category}</td>
                    <td>$${category.total_revenue?.toFixed(2) || '0.00'}</td>
                    <td>${category.total_bookings || 0}</td>
                    <td>${category.avg_cancellation_rate?.toFixed(2) || '0.00'}%</td>
                </tr>
            `).join('');

            return `
                <table class="table table-sm">
                    <thead>
                        <tr><th>Category</th><th>Revenue</th><th>Bookings</th><th>Cancel Rate</th></tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        }

        function loadCombinedChart() {
            fetch('/api/analytics/dashboard')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        createCombinedChart(data);
                    }
                })
                .catch(error => {
                    console.error('Error loading combined chart data:', error);
                });
        }

        function createCombinedChart(data) {
            const ctx = document.getElementById('combinedChart').getContext('2d');

            const mongoData = data.mongoTopProvidersByRevenue || [];
            const jdbcData = data.jdbcTopPerformers || [];

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['MongoDB Revenue', 'JDBC Performance', 'JPA Users', 'Combined Total'],
                    datasets: [{
                        label: 'Data Count',
                        data: [
                            mongoData.length,
                            jdbcData.length,
                            10, // JPA users count (placeholder)
                            mongoData.length + jdbcData.length + 10
                        ],
                        backgroundColor: [
                            '#47A248', // MongoDB green
                            '#00758F', // MySQL blue
                            '#6DB33F', // Spring green
                            '#6f42c1'  // Combined purple
                        ],
                        borderColor: [
                            '#47A248',
                            '#00758F',
                            '#6DB33F',
                            '#6f42c1'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Multi-Database Data Distribution'
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
